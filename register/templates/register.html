{% extends "base.html" %}
{% import "bootstrap_wtf.html" as wtf %}

{% block content %}
<h1>Register Player</h1>
	<form class="form form-horizontal" method="post" action="/register">
		{{ form.hidden_tag() }}
		
		{{ wtf.horizontal_field(form.first_name) }}
		{{ wtf.horizontal_field(form.last_name) }}

		<div class="control-group ">
			<label class="control-label" for="date_of_birth">Date of Birth</label>
			<div class="controls">
				<div class="input-append date">
					<input id="date_of_birth" name="date_of_birth" type="text" readonly="readonly">
					<span class="add-on"><i class="icon-calendar"></i></span>
				</div>
			</div>
		</div>
		{{ wtf.horizontal_field(form.gender) }}

		{{ wtf.horizontal_field(form.age_group_id) }}

		{{ wtf.horizontal_field(form.notes, placeholder="Please list any health concerns, allergies, etc.", rows="5") }}
		{{ wtf.horizontal_field(form.pooling, placeholder="Please list any special requests here.  For example, if you want your child to play with another player or in another park, please specify here.", rows="5") }}

		<div class="control-group">
			<div class="controls">
				<label class="checkbox">
					<input id="allstar" name="allstar" type="checkbox"> Please send me information about the All-Star/Selects program
				</label>
			</div>
		</div>

		<fieldset>
			<legend>Playing History</legend>
			<div class="control-group">
				<div class="controls">
					<label class="checkbox">
						<input id="played_before" name="played_before" type="checkbox" data-bind="checked: played_before"> Has the player played this sport before?
					</label>
				</div>
			</div>

			<div data-bind="visible: played_before">
				{{ wtf.horizontal_field(form.played_years) }}
				{{ wtf.horizontal_field(form.played_position) }}
			</div>

			<div data-bind="visible: isSoccer()">
				<div class="control-group">
					<div class="controls">
						<label class="checkbox">
							<input id="osa_another_country" name="osa_another_country" type="checkbox" data-bind="checked: osa_another_country"> Has the player registered to play soccer in another country?
						</label>
					</div>
				</div>
				<div data-bind="visible: osa_another_country">
					{{ wtf.horizontal_field(form.osa_what_year) }}
					{{ wtf.horizontal_field(form.osa_what_country) }}
					{{ wtf.horizontal_field(form.osa_what_club) }}
				</div>
			</div>
		</fieldset>

		<fieldset>
			<legend>Emergency Contact</legend>
			{{ wtf.horizontal_field(form.ec_name) }}
			{{ wtf.horizontal_field(form.ec_num) }}
		</fieldset>

		<h2>Agreements</h2>

		<div data-bind="visible: isSoccer()">
			{% include "_soccer_legal.html" %}
		</div>

		<div data-bind="visible: isSoftball()">
			{% include "_softball_legal.html" %}
		</div>

		<p><strong>By continuing with registration, you agree that you are the parent or legal guardian of the player being registered and to be bound by the above Legal Agreements even if you have not read them.</strong></p>

		<div class="form-actions">
			<button name="register" type="submit" class="btn btn-primary"><i class="icon-user"></i> Register</button>
		</div>
	</form>
{% endblock %}

{% block bootstrap_js_bottom %}
{{ super() }}

<script>
	// Wire up attributes.
	$("#gender").attr("data-bind", "value: gender");
	$("#date_of_birth").attr("data-bind", "value: date_of_birth, valueUpdate: 'afterkeydown'");
	$("#age_group_id").attr("data-bind", "options: programs, optionsText: 'text', optionsValue: 'id', value: program, optionsCaption: 'Select a Program...'");

	var Register = function() {
		var self = this;

		self.played_before = ko.observable($("#played_before").is(":checked"));
		self.osa_another_country = ko.observable($("#osa_another_country").is(":checked"));
		self.gender = ko.observable();
		self.date_of_birth = ko.observable($("#date_of_birth").val());
		self.programs = ko.observableArray([]);
		self.program = ko.observable();

		self.loadPrograms = function(gender, date_of_birth) {
			if (gender && date_of_birth && date_of_birth.length == 10) {
				$.getJSON("/api/programs", {
						gender: gender,
						date_of_birth: date_of_birth
					},
					function(data) {
						self.programs(data.programs);
					}
				);
			}
		};

		self.isSoccer = function() {
			if (self.program() == undefined) return false;

			for (i in self.programs()) {
				var program = self.programs()[i];
				
				if ((program.id == self.program()) && (program.sport == "Soccer")) {
					return true;
				}
			}

			return false;
		};

		self.isSoftball = function() {
			if (self.program() == undefined) return false;

			for (i in self.programs()) {
				var program = self.programs()[i];
				
				if ((program.id == self.program()) && (program.sport == "Softball")) {
					return true;
				}
			}

			return false;
		};

		self.gender.subscribe(function(gender) {
			self.loadPrograms(gender, self.date_of_birth());
		});

		self.date_of_birth.subscribe(function(date_of_birth) {
				self.loadPrograms(self.gender(), date_of_birth);
		});
	};

	ko.applyBindings(new Register());

	$(".date").datepicker({
		format: "yyyy-mm-dd",
		startView: "decade",
	});

	$("#ec_num").mask("(999) 999-9999");	
</script>
{% endblock %}
